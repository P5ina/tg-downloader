name: Deploy

on:
  push:
    branches:
      - main
      - staging

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Set deployment variables
        id: vars
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "deploy_path=~/projects/tg-downloader" >> $GITHUB_OUTPUT
            echo "container_name=tg-downloader-bot-1" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "deploy_path=~/projects/tg-downloader-staging" >> $GITHUB_OUTPUT
            echo "container_name=tg-downloader-staging-bot" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to ${{ steps.vars.outputs.environment }}
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ steps.vars.outputs.deploy_path }}
            git pull origin ${{ github.ref_name }}
            docker compose up -d --build
            echo "Deployed ${{ github.ref_name }} to ${{ steps.vars.outputs.environment }}"
            docker logs ${{ steps.vars.outputs.container_name }} --tail 10
